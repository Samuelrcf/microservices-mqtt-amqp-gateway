package com.ufersa.mqttservice.services;

import org.eclipse.paho.client.mqttv3.MqttClient;
import org.eclipse.paho.client.mqttv3.MqttConnectOptions;
import org.eclipse.paho.client.mqttv3.MqttException;
import org.springframework.stereotype.Service;

import jakarta.annotation.PostConstruct;

@Service
public class MQTTService {
	
    private static final String BROKER_URL = "tcp://broker.hivemq.com:1883";
    private static final String TOPIC = "dados_processados/todos";
	private MqttClient client;

	@PostConstruct
	public void init() {
		try {
			client = new MqttClient(BROKER_URL, MqttClient.generateClientId());
			MqttConnectOptions options = new MqttConnectOptions();
			options.setAutomaticReconnect(true);
			options.setCleanSession(true);

			client.connect(options);
			System.out.println("Consumidor MQTT conectado ao broker.");
			System.out.println("Inscrito no tÃ³pico: " + TOPIC);

			client.subscribe(TOPIC, (topic, message) -> {
				System.out.println("Mensagem recebida [MQTT]: " + new String(message.getPayload()));
			});

		} catch (MqttException e) {
			e.printStackTrace();
		}
	}
}
